<html>
<head>
	<title>Weather</title>
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
	<body>
		
		<div class="wrapper">

			<div class="sidebyside">
				<h1>Tuuli (10min)</h1>
				<p>
					Nopeus (nyt):<br>
					Suunta (nyt):<br>
					Puuska nopeus:<br>
					Nopeuden keskiarvo:<br>
					Suunnan keskiarvo:<br>
				</p>
				<h1>Muut</h1>
				<p>
					Lämpötila:<br>
					Keskilämpötila:<br>
					Kosteus:<br>
					Ilmanpaine:<br>
					Valoisuus:<br>
					Kastepiste:<br>
					Absoluuttinen kosteus:<br>
					Tuntuu kuin:<br>
				</p>
				<h1>Ennustus tänään</h1>
				<p>
					Auringon nousu:<br>
					Auringon lasku:<br>
					Lämpötila:<br>
					UV indeksi:<br>
					Tuulen nopeus:<br>
					Kuvailu:<br>
				</p>
			</div>

			<div class="sidebyside">
				<h1>&nbsp;</h1>
				<p id="wind"></p>
				<h1>&nbsp;</h1>
				<p id="other"></p>
				<h1>&nbsp;</h1>
				<p id="today"></p>
			</div>

			<div class="canvascontainer">
				<canvas width="500" height="500" id="direction"></canvas>
				<img class="bigicon "id="icon" width="200" height="200">
			</div>
		</div>

		<h1 class="indepent">Viikon ennuste</h1>
		<div class="indepent">
			<ul id="row1">
				
			</ul>
			<ul id="row2">
			</ul>
		</div>

		<p class="indepent">
			&copy; Antti.Codes 2020<br>
			<a href="https://github.com/Chicken-E/WeatherApi" target="_blank">Source on github</a>
		</p>

		<script>

			const canvas = document.getElementById('direction');
			const ctx = canvas.getContext('2d');
			const tausta = new Image();
			tausta.src = './media/tausta.png';
			const nuoli = new Image();
			nuoli.src = './media/nuoli.png';

			async function draw(degrees){
				await ctx.drawImage(tausta, 0, 0)
				await ctx.save();
			    await ctx.translate(canvas.width/2,canvas.height/2);
			    await ctx.rotate(degrees*Math.PI/180);
			    await ctx.drawImage(nuoli,-nuoli.width/2,-nuoli.width/2);
			    await ctx.restore();
			}

			function formatTime(time) {
				let time2 = new Date(time/*+(1000*60*60*3)*/)
				return `${time2.getHours().toString().padStart(2,"0")}:${time2.getMinutes().toString().padStart(2,"0")}`
			}

			function formatDate(time) {
				let time2 = new Date(time/*+(1000*60*60*3)*/)
				return `${["su","ma","ti","ke","to","pe","la"][time2.getDay()]} ${time2.getDate()}.${time2.getMonth()+1}`
			}

			async function updateData() {
			
				let data = await fetch('/api/weather');
				data = await data.json();
			
				let {
					windSpeedNow,
					windSpeedNowText,
					windDirNow,
					windDirNowText,
					windGust,
					windGustText,
					windSpeedAvg,
					windSpeedAvgText,
					windDirAvg,
					windDirAvgText,
					temperature,
					dailyTempAvg,
					humidity,
					pressure,
					lightness,
					dewPoint,
					absoluteHumidity,
					feelsLikeTemp
				} = data;

				let forecast = await fetch('/api/forecast');
				forecast = await forecast.json();

				document.getElementById('wind').innerHTML =
				`${windSpeedNowText} (${windSpeedNow} m/s)
				${windDirNowText} (${windDirNow} &#176;)
				${windGustText} (${windGust} m/s)
				${windSpeedAvgText} (${windSpeedAvg} m/s)
				${windDirAvgText} (${windDirAvg} &#176;)`
				.split('\n').join('<br>');
			
				document.getElementById('other').innerHTML =
				`${temperature} &#176;C
				${dailyTempAvg == undefined ? "Ei tarpeeksi dataa." : `${dailyTempAvg} &#176;C`}
				${humidity} %
				${pressure} hPa
				${lightness} lx
				${dewPoint} &#176;C
				${absoluteHumidity} g/m³
				${feelsLikeTemp}&#176;C`
				.split('\n').join('<br>')

				document.getElementById('today').innerHTML =
				`${formatTime(forecast.today.sunrise*1000)}
				${formatTime(forecast.today.sunset*1000)}
				${forecast.today.temp.max.toFixed(1)} &#176;C  / ${forecast.today.temp.min.toFixed(1)} &#176;C (max/min)
				${forecast.today.uv}
				${forecast.today.windspeed} m/s
				${forecast.today.summary.replace(/^./, v=>v.toUpperCase())}.`
				.split('\n').join('<br>')

				document.getElementById('icon').src=`https://openweathermap.org/img/wn/${forecast.today.icon}@4x.png`

				document.getElementById('row1').innerHTML = ""
				document.getElementById('row2').innerHTML = ""
				let i = 0
				forecast.week.forEach(d=>{
					i++;
					let target
					if(i>4) {
						target = document.getElementById('row2')
					} else {
						target = document.getElementById('row1')
					}
					let el = document.createElement("li")
					el.setAttribute('class', 'day');
					el.innerHTML =
					`
					<div class="datecontainer">
						<p class="date">${formatDate(d.time*1000)}</p>
					</div>
					<img class="smallicon" src="https://openweathermap.org/img/wn/${d.icon}@2x.png">
					<p>Ylin: ${d.temp.max.toFixed(1)} &#176;C</p>
					<p>Alin: ${d.temp.min.toFixed(1)} &#176;C</p>
					<p>${d.windspeed.toFixed(1)} m/s</p>
					`
					target.appendChild(el);
				})

				draw(windDirAvg)
			}

			updateData()
			setInterval(updateData, 2000)
		
		</script>
</body>
</html>
